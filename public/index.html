<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anpassa | Math Platform</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- VISUAL COMPONENTS ---
        
        const GraphCanvas = ({ data }) => {
            const canvasRef = useRef(null);

            useEffect(() => {
                const canvas = canvasRef.current;
                if (!canvas || !data) return;
                const ctx = canvas.getContext('2d');
                const width = canvas.width;
                const height = canvas.height;
                const range = data.range || 10;
                
                ctx.clearRect(0, 0, width, height);
                
                const toX = (val) => (val + range) * (width / (range * 2));
                const toY = (val) => height - (val + range) * (height / (range * 2));

                // Grid
                ctx.strokeStyle = '#e5e7eb';
                ctx.lineWidth = 1;
                for (let i = -range; i <= range; i += data.gridStep || 1) {
                    ctx.beginPath(); ctx.moveTo(toX(i), 0); ctx.lineTo(toX(i), height); ctx.stroke();
                    ctx.beginPath(); ctx.moveTo(0, toY(i)); ctx.lineTo(width, toY(i)); ctx.stroke();
                }

                // Axes
                ctx.strokeStyle = '#374151';
                ctx.lineWidth = 2;
                ctx.beginPath(); ctx.moveTo(toX(0), 0); ctx.lineTo(toX(0), height); ctx.stroke();
                ctx.beginPath(); ctx.moveTo(0, toY(0)); ctx.lineTo(width, toY(0)); ctx.stroke();

                // Lines
                data.lines.forEach(line => {
                    ctx.strokeStyle = line.color || '#dc2626';
                    ctx.lineWidth = 3;
                    ctx.beginPath();
                    const x1 = -range; const y1 = line.slope * x1 + line.intercept;
                    const x2 = range; const y2 = line.slope * x2 + line.intercept;
                    ctx.moveTo(toX(x1), toY(y1)); ctx.lineTo(toX(x2), toY(y2)); ctx.stroke();
                });
            }, [data]);

            return <div className="flex justify-center my-4"><canvas ref={canvasRef} width={300} height={300} className="bg-white rounded border border-gray-300 shadow-sm" /></div>;
        };

        const ScaleVisual = ({ data }) => {
            const ShapeIcon = ({ size }) => (
                <div className={`border-2 border-indigo-500 bg-indigo-50 flex items-center justify-center text-xs text-indigo-700 font-bold shadow-sm rounded`} 
                     style={{ width: size, height: size }}>
                    {data.shape || 'Box'}
                </div>
            );

            // Level 1-2: Single Shape
            if (data.type === 'scale_single') {
                return (
                    <div className="flex flex-col items-center gap-2 my-4">
                        <ShapeIcon size="80px" />
                        <span className="bg-white px-3 py-1 rounded shadow text-sm font-mono border">{data.label}</span>
                    </div>
                );
            }

            // Level 3: Comparison
            if (data.type === 'scale_compare') {
                return (
                    <div className="flex items-end justify-center gap-8 my-6">
                        <div className="flex flex-col items-center gap-2">
                            <span className="text-xs font-bold uppercase text-gray-400">{data.leftLabel}</span>
                            <ShapeIcon size="50px" />
                            <span className="text-sm font-mono">{data.leftValue}</span>
                        </div>
                        <div className="pb-8 text-gray-300 text-2xl">→</div>
                        <div className="flex flex-col items-center gap-2">
                            <span className="text-xs font-bold uppercase text-gray-400">{data.rightLabel}</span>
                            <ShapeIcon size="100px" />
                            <span className="text-sm font-mono">{data.rightValue}</span>
                        </div>
                    </div>
                );
            }
            return null;
        };

        // --- MAIN APP ---
        function App() {
            const [topic, setTopic] = useState('scale');
            const [level, setLevel] = useState(1);
            const [question, setQuestion] = useState(null);
            const [input, setInput] = useState('');
            const [feedback, setFeedback] = useState(null);
            const [loading, setLoading] = useState(false);

            const fetchQuestion = async (t = topic, l = level) => {
                setLoading(true); setFeedback(null); setInput('');
                try {
                    const res = await fetch(`/api/question?topic=${t}&level=${l}`);
                    const data = await res.json();
                    setQuestion(data);
                } catch(e) { console.error(e); }
                finally { setLoading(false); }
            };

            const changeTopic = (t) => { setTopic(t); fetchQuestion(t, level); };
            const changeLevel = (l) => { setLevel(l); fetchQuestion(topic, l); };

            useEffect(() => { fetchQuestion(); }, []);

            const handleSubmit = async (e) => {
                e.preventDefault();
                if (!question || !input) return;

                const res = await fetch('/api/answer', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ answer: input, token: question.token })
                });
                const result = await res.json();
                setFeedback(result.correct ? 'correct' : 'incorrect');
                if (result.correct) setTimeout(() => fetchQuestion(), 1500);
            };

            return (
                <div className="min-h-screen flex flex-col items-center p-4">
                    {/* Controls */}
                    <div className="flex flex-col items-center gap-4 mb-8 w-full max-w-lg">
                        <nav className="flex flex-wrap gap-2 justify-center">
                            {['scale', 'geometry', 'equation', 'graph', 'simplify'].map(t => (
                                <button key={t} onClick={() => changeTopic(t)} 
                                    className={`px-4 py-2 rounded-full text-sm font-bold capitalize transition-all ${
                                        topic === t ? 'bg-indigo-600 text-white shadow-md' : 'bg-white text-gray-500 hover:bg-gray-200'
                                    }`}>{t}</button>
                            ))}
                        </nav>
                        <div className="flex items-center gap-2 bg-white p-2 rounded-full shadow-sm">
                            <span className="text-xs font-bold text-gray-400 uppercase ml-2 mr-1">Level</span>
                            {[1, 2, 3, 4, 5].map(l => (
                                <button key={l} onClick={() => changeLevel(l)}
                                    className={`w-8 h-8 rounded-full text-sm font-bold transition-all ${
                                        level === l ? 'bg-indigo-100 text-indigo-700 ring-2 ring-indigo-500' : 'bg-gray-100 text-gray-400 hover:bg-gray-200'
                                    }`}>{l}</button>
                            ))}
                        </div>
                    </div>

                    <div className="w-full max-w-lg bg-white rounded-2xl shadow-xl overflow-hidden">
                        {loading ? <div className="p-12 text-center text-gray-400">Laddar...</div> : question ? (
                            <div className="p-6">
                                {/* Visuals */}
                                {question.renderData.graph && <GraphCanvas data={question.renderData.graph} />}
                                {question.renderData.geometry && <ScaleVisual data={question.renderData.geometry} />}
                                
                                <div className="mb-6 text-center space-y-2">
                                    <div className="text-gray-500 text-sm uppercase tracking-wide font-bold">Level {level} • {topic}</div>
                                    <h2 className="text-2xl font-bold text-gray-800">{question.renderData.latex || question.renderData.description}</h2>
                                    {question.renderData.description && !question.renderData.geometry && <p className="text-gray-600">{question.renderData.description}</p>}
                                </div>

                                <form onSubmit={handleSubmit} className="space-y-4">
                                    <input 
                                        type="text" 
                                        value={input}
                                        onChange={(e) => setInput(e.target.value)}
                                        className={`w-full p-4 text-center text-xl border-2 rounded-xl outline-none transition-colors ${
                                            feedback === 'correct' ? 'border-green-500 bg-green-50' : 
                                            feedback === 'incorrect' ? 'border-red-500 bg-red-50' : 'border-gray-200 focus:border-indigo-500'
                                        }`}
                                        placeholder={question.renderData.answerType === 'scale' ? "t.ex. 1:50" : "Skriv ditt svar..."}
                                        autoFocus
                                    />
                                    <button type="submit" className={`w-full py-4 rounded-xl font-bold text-lg text-white transition-transform active:scale-95 ${
                                        feedback === 'correct' ? 'bg-green-500' : 'bg-indigo-600 hover:bg-indigo-700'
                                    }`}>{feedback === 'correct' ? 'Rätt! Nästa...' : 'Svara'}</button>
                                </form>

                                {/* Clues */}
                                <div className="mt-6 border-t pt-4">
                                    <details className="group">
                                        <summary className="cursor-pointer text-gray-400 text-sm font-medium hover:text-indigo-600 list-none text-center">Behöver du hjälp?</summary>
                                        <div className="mt-4 space-y-2 bg-yellow-50 p-4 rounded-lg text-sm text-yellow-800">
                                            {question.clues && question.clues.map((clue, i) => (
                                                <div key={i} className="flex justify-between border-b border-yellow-200 last:border-0 pb-2 last:pb-0">
                                                    <span>{clue.text}</span>
                                                    <span className="font-mono bg-white px-1 rounded">{clue.latex}</span>
                                                </div>
                                            ))}
                                        </div>
                                    </details>
                                </div>
                            </div>
                        ) : <div className="p-12 text-center text-red-400">Kunde inte ladda frågan.</div>}
                    </div>
                </div>
            );
        }
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>